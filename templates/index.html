<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sing-box é…ç½®ç¼–è¾‘å™¨</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <style>
        :root {
            /* æµ…è‰²ä¸»é¢˜å˜é‡ */
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #334155;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --primary-color: #4f46e5;
            /* Indigo */
            --primary-hover: #4338ca;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --success-color: #10b981;
            --code-bg: #f8fafc;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --radius: 8px;
            --header-height: 60px;
        }

        /* æ·±è‰²ä¸»é¢˜å˜é‡ */
        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --primary-color: #6366f1;
            --primary-hover: #818cf8;
            --code-bg: #020617;
            /* æ›´æ·±çš„ä»£ç èƒŒæ™¯ */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.5);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            /* é˜²æ­¢æ•´ä¸ªé¡µé¢æ»šåŠ¨ */
            transition: background-color 0.3s, color 0.3s;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        header {
            height: var(--header-height);
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
            z-index: 10;
        }

        h1 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* é¡¶éƒ¨å³ä¾§å·¥å…·æ  */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-toggle {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
        }

        /* ä¸»å®¹å™¨ */
        #app-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
            /* å†…éƒ¨æ»šåŠ¨ */
        }

        /* è·¯å¾„é€‰æ‹©å™¨é¢æ¿ */
        #config-path-selector-container {
            background-color: var(--bg-card);
            padding: 40px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            max-width: 600px;
            margin: auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 1px solid var(--border-color);
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--code-bg);
            color: var(--text-main);
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        /* ç¼–è¾‘å™¨ä¸»åŒºåŸŸ (ä¸‰åˆ—å¸ƒå±€) */
        #main-editor-container {
            display: flex;
            gap: 15px;
            flex-grow: 1;
            min-height: 0;
            /* å…è®¸ Flex å­é¡¹æ»šåŠ¨ */
        }

        /* é€šç”¨åˆ—æ ·å¼ */
        .editor-column {
            background-color: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .column-header {
            padding: 12px 15px;
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ç¬¬ä¸€åˆ—ï¼šæ–‡ä»¶åˆ—è¡¨ */
        .functional-buttons-column {
            width: 180px;
            flex-shrink: 0;
            overflow-y: auto;
            padding: 10px;
            gap: 5px;
            display: flex;
            flex-direction: column;
        }

        /* ä¾§è¾¹æ æŒ‰é’®æ ·å¼ */
        .config-type-button {
            background: transparent;
            color: var(--text-main);
            border: none;
            padding: 10px 12px;
            text-align: left;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .config-type-button:hover {
            background-color: var(--bg-body);
            color: var(--primary-color);
        }

        .config-type-button.active {
            background-color: rgba(99, 102, 241, 0.1);
            /* Primary color low opacity */
            color: var(--primary-color);
            font-weight: 600;
        }

        .config-type-button.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 60%;
            width: 3px;
            background-color: var(--primary-color);
            border-radius: 0 2px 2px 0;
        }

        /* ç¬¬äºŒåˆ—ï¼šKey åˆ—è¡¨ */
        .hierarchy-selector {
            width: 220px;
            flex-shrink: 0;
        }

        #hierarchy-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }

        #hierarchy-list li {
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-muted);
            transition: background 0.2s;
        }

        #hierarchy-list li:hover {
            background-color: var(--bg-body);
            color: var(--primary-color);
        }

        #hierarchy-list li.active {
            background-color: var(--bg-body);
            color: var(--primary-color);
            font-weight: 600;
            border-left: 3px solid var(--primary-color);
        }

        /* ç¼–è¾‘å™¨åŒºåŸŸ (Textarea) */
        .fragment-editor,
        .full-config-editor {
            flex-grow: 1;
            flex-basis: 0;
            min-width: 0;
            /* é˜²æ­¢å†…å®¹æ’‘å¼€ */
        }

        textarea {
            width: 100%;
            height: 100%;
            padding: 15px;
            border: none;
            resize: none;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            background-color: var(--code-bg);
            color: var(--text-main);
            outline: none;
        }

        textarea::placeholder {
            color: var(--text-muted);
            opacity: 0.5;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* åº•éƒ¨æ“ä½œæ  */
        #global-action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding-top: 10px;
            flex-shrink: 0;
        }

        button.btn-primary,
        button.btn-warning,
        button.btn-action {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: transform 0.1s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        button.btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        button.btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button.btn-warning {
            background-color: var(--warning-color);
            color: #1e293b;
            /* Dark text for contrast */
        }

        button.btn-warning:hover:not(:disabled) {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button.btn-action {
            background-color: var(--success-color);
            color: white;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(0.5);
        }

        /* Toast æç¤º */
        .toast-notification {
            position: fixed;
            top: 80px;
            /* æ”¹ä¸ºé¡¶éƒ¨æ˜¾ç¤º */
            right: 20px;
            background-color: var(--bg-card);
            color: var(--text-main);
            padding: 15px 20px;
            border-radius: 8px;
            border-left: 5px solid var(--primary-color);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            font-weight: 500;
        }

        .toast-notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-notification.success {
            border-left-color: var(--success-color);
        }

        .toast-notification.error {
            border-left-color: var(--danger-color);
        }

        /* æ¨¡æ€æ¡†ç¾åŒ– */
        .modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: var(--bg-card);
            color: var(--text-main);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal h3 {
            margin-top: 0;
            font-size: 1.5rem;
        }

        .modal h3.error {
            color: var(--danger-color);
        }

        .modal-actions {
            margin-top: 25px;
            text-align: right;
        }

        .close-button {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .close-button:hover {
            color: var(--text-main);
        }

        #modal-message {
            white-space: pre-wrap;
            background-color: var(--code-bg);
            padding: 15px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 900px) {
            body {
                height: auto;
                overflow-y: auto;
            }

            #app-container {
                height: auto;
                overflow: visible;
                padding: 10px;
            }

            #config-path-selector-container {
                padding: 20px;
            }

            #main-editor-container {
                flex-direction: column;
                overflow: visible;
                gap: 10px;
            }

            .functional-buttons-column,
            .hierarchy-selector {
                width: 100%;
                height: auto;
                max-height: 200px;
            }

            /* ç§»åŠ¨ç«¯æ–‡æœ¬æ¡†å­—ä½“é˜²ç¼©æ”¾ & å…è®¸è‡ªé€‚åº”é«˜åº¦ */
            input,
            select,
            textarea {
                font-size: 16px !important;
            }

            .editor-column {
                height: auto;
                min-height: 500px;
                /* å¢åŠ é«˜åº¦ä»¥æä¾›æ›´å¥½çš„ç¼–è¾‘è§†é‡ */
                flex-shrink: 0;
                display: flex;
                flex-direction: column;
            }

            .editor-column textarea {
                flex-grow: 1;
                /* å¼ºåˆ¶æ–‡æœ¬æ¡†å¡«æ»¡å‰©ä½™ç©ºé—´ */
                height: auto;
                /* é‡ç½®é«˜åº¦ï¼Œç”± flex æ§åˆ¶ */
            }

            #global-action-buttons {
                flex-direction: column;
                padding-bottom: 20px;
            }

            button {
                width: 100%;
                justify-content: center;
                padding: 12px;
                /* æ›´å¤§çš„ç‚¹å‡»åŒºåŸŸ */
            }
        }
    </style>
</head>

<body>

    <header>
        <h1>âš¡ Sing-box Editor</h1>
        <div class="header-actions">
            <button class="theme-toggle" id="theme-toggle" title="åˆ‡æ¢æ·±è‰²/æµ…è‰²ä¸»é¢˜">ğŸŒ“</button>
        </div>
    </header>

    <div id="toast-notification" class="toast-notification"></div>

    <div id="notification-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-title">æ ‡é¢˜</h3>
            <div id="modal-message">æ¶ˆæ¯å†…å®¹</div>
            <div class="modal-actions">
                <button id="modal-confirm-button" class="btn-primary">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <div id="app-container">

        <div id="config-path-selector-container">
            <h2 style="color: var(--primary-color);">é…ç½®ç›®å½•è®¾ç½®</h2>
            <p style="color: var(--text-muted);">è¯·é€‰æ‹© Sing-box é…ç½®æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹</p>

            <select id="config-path-select">
                <option value="" disabled selected>æ­£åœ¨æ‰«æè·¯å¾„...</option>
            </select>

            <div style="display: flex; align-items: center; gap: 10px; width: 100%;">
                <span style="flex-shrink: 0; font-size: 0.9em; color: var(--text-muted);">æˆ–æ‰‹åŠ¨:</span>
                <input type="text" id="manual-path-input" placeholder="/etc/sing-box/">
            </div>

            <button id="set-path-button" class="btn-primary" style="width: 100%;">ç¡®å®šè®¾ç½®</button>

            <div style="font-size: 0.85em; color: var(--text-muted); margin-top: 10px;">
                å½“å‰è·¯å¾„: <span id="current-active-path-display"
                    style="font-family: monospace; color: var(--primary-color);">æœªè®¾ç½®</span>
            </div>
            <p id="config-path-message" style="color: var(--danger-color); font-size: 0.9em;"></p>
        </div>

        <div id="main-editor-container" style="display: none;">

            <div class="editor-column functional-buttons-column" id="functional-buttons-column">
                <div class="column-header">æ–‡ä»¶åˆ—è¡¨</div>
                <p class="message" style="padding: 10px; font-size: 0.85rem; color: var(--text-muted);">åŠ è½½ä¸­...</p>
            </div>

            <div class="editor-column hierarchy-selector">
                <div class="column-header">é…ç½®ç»“æ„ Key</div>
                <ul id="hierarchy-list">
                    <p class="message" style="padding: 10px; font-size: 0.85rem; color: var(--text-muted);">è¯·å…ˆé€‰æ‹©æ–‡ä»¶</p>
                </ul>
            </div>

            <div class="editor-column fragment-editor">
                <div class="column-header">
                    <span>âœï¸ ç‰‡æ®µç¼–è¾‘</span>
                    <span style="font-size: 0.75rem; font-weight: 400; opacity: 0.7;">(é€‰ä¸­å·¦ä¾§ Key ç¼–è¾‘)</span>
                </div>
                <textarea id="fragment-content-area" placeholder="// é€‰æ‹©å·¦ä¾§ Key ä»¥ç¼–è¾‘å±€éƒ¨ç‰‡æ®µ..."></textarea>
            </div>

            <div class="editor-column full-config-editor">
                <div class="column-header">
                    <span>ğŸ“„ å®Œæ•´æ–‡ä»¶</span>
                    <span style="font-size: 0.75rem; font-weight: 400; opacity: 0.7;">(æœ€ç»ˆåˆå¹¶ç»“æœ)</span>
                </div>
                <textarea id="full-config-content-area" placeholder="// é€‰æ‹©æ–‡ä»¶æŸ¥çœ‹å®Œæ•´å†…å®¹..."></textarea>
            </div>
        </div>

        <div id="global-action-buttons" style="display: none;">
            <button id="save-config-button" class="btn-primary" disabled>
                <span>ğŸ’¾</span> ä¿å­˜é…ç½® & æ£€æŸ¥
            </button>
            <button id="restart-service-button" class="btn-warning" disabled>
                <span>ğŸ”„</span> é‡å¯æœåŠ¡
            </button>
        </div>
    </div>

    <script>
        // --- 1. ä¸»é¢˜åˆ‡æ¢é€»è¾‘ ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const body = document.body;

        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ä¸»é¢˜
        const savedTheme = localStorage.getItem('singbox-theme');
        if (savedTheme) {
            body.setAttribute('data-theme', savedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            body.setAttribute('data-theme', 'dark'); // é»˜è®¤è·Ÿéšç³»ç»Ÿ
        }

        themeToggleBtn.addEventListener('click', () => {
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('singbox-theme', newTheme);
        });

        // --- 2. åŸæœ‰çš„ä¸šåŠ¡é€»è¾‘ (å·²åŒ…å«ä¹‹å‰çš„ä¿®å¤) ---

        // DOM å…ƒç´ å¼•ç”¨
        const toastNotification = document.getElementById('toast-notification');
        const notificationModal = document.getElementById('notification-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmButton = document.getElementById('modal-confirm-button');
        const closeModalButton = notificationModal.querySelector('.close-button');

        const configPathSelectorContainer = document.getElementById('config-path-selector-container');
        const configPathSelect = document.getElementById('config-path-select');
        const manualPathInput = document.getElementById('manual-path-input');
        const setPathButton = document.getElementById('set-path-button');
        const currentActivePathDisplay = document.getElementById('current-active-path-display');
        const configPathMessage = document.getElementById('config-path-message');

        const mainEditorContainer = document.getElementById('main-editor-container');
        const functionalButtonsColumn = document.getElementById('functional-buttons-column');
        const hierarchyList = document.getElementById('hierarchy-list');
        const hierarchySelectorColumn = document.querySelector('.hierarchy-selector');
        const fragmentContentArea = document.getElementById('fragment-content-area');
        const fullConfigContentArea = document.getElementById('full-config-content-area');

        const globalActionButtons = document.getElementById('global-action-buttons');
        const saveConfigButton = document.getElementById('save-config-button');
        const restartServiceButton = document.getElementById('restart-service-button');

        // çŠ¶æ€å˜é‡
        let currentFilename = '';
        let currentJsonPath = '';
        let currentRootContextKey = '';
        let activeTopButton = null;
        let activeHierarchyItem = null;
        let currentActiveConfigPath = '';

        // æ ¸å¿ƒå˜é‡ï¼šè®°å½•ç”¨æˆ·æœ€åæ“ä½œçš„æ˜¯å“ªä¸ªç¼–è¾‘å™¨
        let lastActiveEditor = 'full'; // 'fragment' æˆ– 'full'

        // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºè‡ªåŠ¨æ¶ˆå¤±çš„æç¤ºæ¡† (Toast)
        function showToast(message, type = 'info', duration = 3000) {
            toastNotification.textContent = message;
            toastNotification.className = `toast-notification show ${type}`;
            clearTimeout(toastNotification.timer);
            toastNotification.timer = setTimeout(() => {
                toastNotification.classList.remove('show');
            }, duration);
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºéœ€è¦ç”¨æˆ·ç¡®è®¤çš„æ¨¡æ€æ¡†
        function showModal(title, message, type = 'info') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalTitle.className = type;
            if (type === 'error') {
                modalMessage.style.color = 'var(--danger-color)';
            } else {
                modalMessage.style.color = 'var(--text-main)';
            }

            notificationModal.classList.add('show');

            return new Promise(resolve => {
                const confirmHandler = () => {
                    notificationModal.classList.remove('show');
                    modalConfirmButton.removeEventListener('click', confirmHandler);
                    closeModalButton.removeEventListener('click', confirmHandler);
                    resolve(true);
                };
                modalConfirmButton.addEventListener('click', confirmHandler);
                closeModalButton.addEventListener('click', confirmHandler);
            });
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºæç¤ºä¿¡æ¯åœ¨æŒ‡å®šå…ƒç´ 
        function showMessage(element, message, type = 'info') {
            element.innerHTML = `<p class="message ${type}" style="padding:10px; color:var(--text-muted); font-size:0.85em;">${message}</p>`;
        }
        function clearMessage(element) {
            element.innerHTML = '';
        }

        // è¾…åŠ©å‡½æ•°ï¼šå°†JSONå­—ç¬¦ä¸²æ ¼å¼åŒ–
        function formatJson(jsonString) {
            try {
                const obj = JSON.parse(jsonString);
                return JSON.stringify(obj, null, 2);
            } catch (e) {
                return jsonString;
            }
        }

        // ---------- API è°ƒç”¨å‡½æ•° ----------
        async function fetchConfigPaths() {
            try {
                const response = await fetch('/api/get_config_paths');
                if (!response.ok) throw new Error(response.statusText);
                return await response.json();
            } catch (error) {
                configPathMessage.textContent = `è·å–è·¯å¾„å¤±è´¥: ${error.message}`;
                return { found_paths: [] };
            }
        }

        async function setActiveConfigPath(path) {
            try {
                const response = await fetch('/api/set_active_config_path', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        async function fetchFunctionalConfigs() {
            try {
                const response = await fetch('/api/get_functional_configs');
                if (!response.ok) throw new Error(response.statusText);
                return await response.json();
            } catch (error) {
                return { ordered_functional_config: [] };
            }
        }

        async function fetchTopKeys(filename) {
            try {
                const response = await fetch(`/api/get_top_keys?filename=${encodeURIComponent(filename)}`);
                if (!response.ok) throw new Error(response.statusText);
                return await response.json();
            } catch (error) {
                return { Keys: [] };
            }
        }

        async function fetchFileContent(filename, path = '') {
            try {
                let url = `/api/get_content?filename=${encodeURIComponent(filename)}`;
                if (path) url += `&path=${encodeURIComponent(path)}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error(response.statusText);
                return await response.text();
            } catch (error) {
                showToast(`è·å–å†…å®¹å¤±è´¥: ${error.message}`, 'error');
                return '';
            }
        }

        async function performSave(filename, content, path = '') {
            try {
                const response = await fetch('/api/save_content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename, content, path })
                });
                const result = await response.json();
                if (response.ok) {
                    return { success: true, message: result.message };
                } else {
                    return { success: false, message: result.message || 'ä¿å­˜å¤±è´¥' };
                }
            } catch (error) {
                return { success: false, message: 'ç½‘ç»œè¯·æ±‚å¤±è´¥' };
            }
        }

        async function restartSingboxService() {
            try {
                const response = await fetch('/api/restart_singbox', { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || response.statusText);
                return { success: true, message: result.message };
            } catch (error) {
                return { success: false, message: error.message };
            }
        }

        async function checkConfig() {
            try {
                const response = await fetch('/api/check_config', { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || response.statusText);
                return result;
            } catch (error) {
                return { status: "error", message: error.message };
            }
        }

        // ---------- UI é€»è¾‘ ----------

        function calculateFunctionalButtonWidth(buttonsData) {
            // CSS å·²ç»å¤„ç†äº†å®½åº¦ï¼Œè¿™é‡Œç•™ç©ºä»¥ä¿æŒå…¼å®¹æ€§
        }

        function calculateHierarchyColumnWidth(itemsData) {
            // CSS å·²ç»å¤„ç†äº†å®½åº¦
        }

        function highlightTopButton(button) {
            if (activeTopButton) activeTopButton.classList.remove('active');
            if (button) {
                button.classList.add('active');
                activeTopButton = button;
            } else {
                activeTopButton = null;
            }
        }

        function highlightHierarchyItem(item) {
            if (activeHierarchyItem) activeHierarchyItem.classList.remove('active');
            if (item) {
                item.classList.add('active');
                activeHierarchyItem = item;
            } else {
                activeHierarchyItem = null;
            }
        }

        function setSaveButtonsState(enabled) {
            saveConfigButton.disabled = !enabled;
            restartServiceButton.disabled = !enabled;
        }

        // ---------- äº‹ä»¶å¤„ç† ----------

        async function loadConfigPathSelector() {
            configPathSelectorContainer.style.display = 'flex';
            mainEditorContainer.style.display = 'none';
            globalActionButtons.style.display = 'none';

            const pathResponse = await fetchConfigPaths();
            const foundPaths = pathResponse.found_paths || [];
            currentActiveConfigPath = pathResponse.current_active_path || '';

            configPathSelect.innerHTML = '<option value="" disabled selected>-- è¯·é€‰æ‹©è·¯å¾„ --</option>';
            foundPaths.forEach(path => {
                const option = document.createElement('option');
                option.value = path;
                option.textContent = path;
                configPathSelect.appendChild(option);
            });

            if (currentActiveConfigPath) {
                await loadEditorUI();
            }
        }

        async function handleSetConfigPathClick() {
            let selectedPath = configPathSelect.value || manualPathInput.value.trim();
            if (!selectedPath) return;
            const success = await setActiveConfigPath(selectedPath);
            if (success) {
                currentActiveConfigPath = selectedPath;
                await loadEditorUI();
            }
        }

        async function loadEditorUI() {
            configPathSelectorContainer.style.display = 'none';
            mainEditorContainer.style.display = 'flex';
            globalActionButtons.style.display = 'flex';

            // é»˜è®¤è®¾ç½®ä¸ºå…¨æ–‡ä»¶æ¨¡å¼
            lastActiveEditor = 'full';

            const funcConfigResponse = await fetchFunctionalConfigs();
            const orderedFunctionalConfig = funcConfigResponse.ordered_functional_config || [];

            functionalButtonsColumn.innerHTML = '<div class="column-header">æ–‡ä»¶åˆ—è¡¨</div>'; // Reset with header
            if (orderedFunctionalConfig.length > 0) {
                orderedFunctionalConfig.forEach(config => {
                    const button = document.createElement('button');
                    button.classList.add('config-type-button');
                    button.dataset.filename = config.FileName;
                    button.textContent = config.FunctionName;
                    functionalButtonsColumn.appendChild(button);
                });
            } else {
                showMessage(functionalButtonsColumn, 'æ— é…ç½®æ–‡ä»¶');
            }
        }

        async function handleFunctionalButtonClick(event) {
            const button = event.target.closest('.config-type-button');
            if (!button) return;

            highlightTopButton(button);
            currentFilename = button.dataset.filename;
            currentJsonPath = '';
            currentRootContextKey = '';

            // åˆ‡æ¢æ–‡ä»¶æ—¶ï¼Œé‡ç½®æ¿€æ´»ç¼–è¾‘å™¨ä¸º Full
            lastActiveEditor = 'full';

            fragmentContentArea.value = '';
            fragmentContentArea.placeholder = "â† è¯·ç‚¹å‡»å·¦ä¾§ Key ç¼–è¾‘ç‰‡æ®µ";
            highlightHierarchyItem(null);
            fullConfigContentArea.value = 'æ­£åœ¨åŠ è½½...';

            // 1. è·å–é¡¶å±‚ Key
            const topKeysResponse = await fetchTopKeys(currentFilename);
            currentRootContextKey = topKeysResponse.root_context_key || '';
            const topKeys = topKeysResponse.keys || [];

            hierarchyList.innerHTML = '';
            if (topKeys.length > 0) {
                topKeys.forEach(key => {
                    const li = document.createElement('li');
                    li.textContent = key;
                    li.dataset.jsonPath = currentRootContextKey ? `${currentRootContextKey}.${key}` : key;
                    hierarchyList.appendChild(li);
                });
            } else {
                showMessage(hierarchyList, "æ— é¡¶å±‚ Key");
            }

            // 2. è·å–å®Œæ•´å†…å®¹
            const fullContent = await fetchFileContent(currentFilename);
            fullConfigContentArea.value = formatJson(fullContent);

            setSaveButtonsState(true);
        }

        async function handleHierarchyItemClick(event) {
            const listItem = event.target.closest('li');
            if (!listItem || !currentFilename) return;

            highlightHierarchyItem(listItem);
            currentJsonPath = listItem.dataset.jsonPath;

            // åˆ‡æ¢ç‰‡æ®µæ—¶ï¼Œå°†æ¿€æ´»çŠ¶æ€è®¾ä¸º Fragment
            lastActiveEditor = 'fragment';

            fragmentContentArea.value = 'åŠ è½½ä¸­...';
            const fragmentContent = await fetchFileContent(currentFilename, currentJsonPath);
            fragmentContentArea.value = formatJson(fragmentContent);
        }

        // ---------- æ ¸å¿ƒé€»è¾‘ï¼šç»Ÿä¸€ä¿å­˜å…¥å£ (ä¿æŒä½ è¦æ±‚çš„é€»è¾‘) ----------

        async function handleSaveAndCheck() {
            if (!currentFilename) {
                showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶ï¼', 'error');
                return;
            }

            const btn = saveConfigButton;
            const originalText = btn.innerHTML; // ä¿ç•™ icon
            btn.disabled = true;
            btn.innerHTML = "<span>â³</span> æ­£åœ¨ä¿å­˜...";

            let saveResult;

            try {
                // 1. æ‰§è¡Œä¿å­˜
                if (lastActiveEditor === 'fragment' && currentJsonPath) {
                    console.log('Action: Saving Fragment');
                    const content = fragmentContentArea.value;
                    saveResult = await performSave(currentFilename, content, currentJsonPath);
                } else {
                    console.log('Action: Saving Full File');
                    const content = fullConfigContentArea.value;
                    saveResult = await performSave(currentFilename, content);
                }

                if (!saveResult.success) {
                    throw new Error(saveResult.message);
                }

                // 2. åˆ·æ–°ç•Œé¢
                const newFullContent = await fetchFileContent(currentFilename);
                fullConfigContentArea.value = formatJson(newFullContent);

                if (currentJsonPath) {
                    const newFragmentContent = await fetchFileContent(currentFilename, currentJsonPath);
                    fragmentContentArea.value = formatJson(newFragmentContent);
                }

                showToast('ä¿å­˜æˆåŠŸï¼Œæ­£åœ¨æ£€æŸ¥é…ç½®...', 'info');
                btn.innerHTML = "<span>ğŸ”</span> æ­£åœ¨æ£€æŸ¥...";

                // 3. æ‰§è¡Œæ£€æŸ¥
                const checkResult = await checkConfig();

                if (checkResult.status === "success") {
                    showToast('âœ… ä¿å­˜æˆåŠŸä¸”é…ç½®æ£€æŸ¥é€šè¿‡ï¼', 'success');
                } else {
                    await showModal('é…ç½®æ£€æŸ¥å¤±è´¥', checkResult.message, 'error');
                }

            } catch (error) {
                console.error(error);
                showToast(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function handleOnlyRestart() {
            const btn = restartServiceButton;
            const originalText = btn.innerHTML;

            // Removed confirmation as requested
            // if (!confirm("ç¡®è®¤é‡å¯ Sing-box æœåŠ¡å—ï¼Ÿ\nè¯·ç¡®ä¿ä½ å·²ç»ä¿å­˜å¹¶æ£€æŸ¥äº†é…ç½®ã€‚")) {
            //     return;
            // }

            btn.disabled = true;
            btn.innerHTML = "<span>â³</span> æ­£åœ¨é‡å¯...";

            try {
                const result = await restartSingboxService();
                if (result.success) {
                    showToast('âœ… æœåŠ¡å·²å‘é€é‡å¯å‘½ä»¤ï¼', 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showToast(`é‡å¯å¤±è´¥: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function init() {
            // è·¯å¾„é€‰æ‹©å™¨äº‹ä»¶
            configPathSelect.addEventListener('change', () => { manualPathInput.value = configPathSelect.value; setPathButton.disabled = false; });
            manualPathInput.addEventListener('input', () => { setPathButton.disabled = manualPathInput.value.trim() === ''; });
            setPathButton.addEventListener('click', handleSetConfigPathClick);

            // ç¼–è¾‘å™¨ç‚¹å‡»äº‹ä»¶
            functionalButtonsColumn.addEventListener('click', handleFunctionalButtonClick);
            hierarchyList.addEventListener('click', handleHierarchyItemClick);

            // ç›‘å¬è¾“å…¥äº‹ä»¶
            fragmentContentArea.addEventListener('input', () => { lastActiveEditor = 'fragment'; });
            fragmentContentArea.addEventListener('focus', () => { lastActiveEditor = 'fragment'; });

            fullConfigContentArea.addEventListener('input', () => { lastActiveEditor = 'full'; });
            fullConfigContentArea.addEventListener('focus', () => { lastActiveEditor = 'full'; });

            // ç»‘å®šæ–°æŒ‰é’®äº‹ä»¶
            saveConfigButton.addEventListener('click', handleSaveAndCheck);
            restartServiceButton.addEventListener('click', handleOnlyRestart);

            setSaveButtonsState(false);
            loadConfigPathSelector();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>